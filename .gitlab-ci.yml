default:
    image: plusforta/php-deploy8.2:latest

workflow:
    rules:
        # Always run pipelines for Merge Requests (this rule should take precedence)
        - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
          when: always
        # Skip pipelines on 'develop' if the commit message contains '[no ci]'
        - if: '$CI_COMMIT_BRANCH == "main" && $CI_COMMIT_MESSAGE =~ /(\[no ci\])/i'
          when: never
        # Run pipelines in all other cases
        - when: always

before_script:
    - . "$NVM_DIR/nvm.sh"
    - nvm install
    - nvm use
    - npm install -g yarn

stages:
    - build
    - test
    - commitlint
    - version

composer:
    # The job's stage (build, test or deploy).
    stage: build
    # What to run on the job.
    script:
        - composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts
    artifacts:
        # (Optional) Give it an expiration date,
        # after that period you won't be able to
        # download them via the UI anymore.
        expire_in: 1 week

        # Define what to output from the job.
        paths:
            - vendor/

    cache:
        # The variable CI_COMMIT_REF_SLUG
        # refers to the slug of the branch.
        # For example: `main` for the main branch.
        # We use the `composer` suffix to avoid conflicts with
        # the `npm` cache that we'll define next.
        key: ${CI_COMMIT_REF_SLUG}-composer

        # Define what to cache.
        paths:
            - vendor/

phpunit:
    stage: test

    # List of jobs from which it will download the artifacts.
    dependencies:
        - composer

    script:
        - export APP_ENV=test
        - XDEBUG_MODE=coverage vendor/bin/phpunit --coverage-text --colors=never --coverage-cobertura=coverage.xml tests
    coverage: /^\s*Lines:\s*\d+.\d+\%/
    artifacts:
        when: always
        paths:
            - coverage.xml
        reports:
            coverage_report:
                coverage_format: cobertura
                path: coverage.xml

PHPStyle:
    stage: test
    allow_failure: false
    dependencies:
        - composer
    script:
        - ./vendor/bin/ecs --output-format=gitlab > gl-php-code-quality-report.json
    artifacts:
        when: always
        paths:
            - gl-php-code-quality-report.json
        reports:
            codequality: gl-php-code-quality-report.json

commit-check:
    stage: commitlint
    script:
        - git fetch origin main --unshallow
        - yarn install
        - yarn commitlint --from origin/main --to HEAD
    only:
        - branches
        - merge_requests

version:
    stage: version
    script:
        - yarn install
        - yarn semantic-release
    variables:
        GITLAB_TOKEN: $PAT_SEMANTIC_RELEASE
    only:
        - main